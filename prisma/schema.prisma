// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum UserRole {
  admin
  manager
  partner
  client
}

enum TireSeason {
  summer
  winter
  all_season
}

enum TireStatus {
  storage
  issued
  archived
}

enum OrderStatus {
  active
  completed
  overdue
  cancelled
  expiring
}

enum PaymentStatus {
  unpaid
  partial
  paid
}

enum AppointmentStatus {
  pending
  confirmed
  completed
  cancelled
}

enum ServiceType {
  mounting
  storage
  balancing
  repair
  other
}

model User {
  id            String    @id @default(uuid())
  telegramId    BigInt?   @unique @map("telegram_id")
  username      String?
  phone         String?   @unique
  email         String?   @unique
  role          UserRole  @default(client)
  fullName      String    @map("full_name")
  
  // Поля для клиента
  carNumber     String?   @map("car_number")
  address       String?
  trafficSource String?   @map("traffic_source")
  clientNotes   String?   @map("client_notes")
  
  // Поля для партнера
  services      Json?     // Array of services
  schedule      Json?     // Schedule object
  isActive      Boolean   @default(true) @map("is_active")
  
  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")
  deletedAt     DateTime? @map("deleted_at")
  
  // Relations
  tires         Tire[]    @relation("ClientTires")
  orders        Order[]   @relation("ClientOrders")
  managedOrders Order[]   @relation("ManagerOrders")
  appointments  Appointment[] @relation("ClientAppointments")
  partnerAppointments Appointment[] @relation("PartnerAppointments")
  notifications Notification[]
  
  @@index([telegramId])
  @@index([role])
  @@index([phone])
  @@map("users")
}

model Tire {
  id            String      @id @default(uuid())
  clientId      String      @map("client_id")
  brand         String
  model         String
  size          String
  season        TireSeason
  description   String?
  status        TireStatus  @default(storage)
  wearLevel     Int?        @map("wear_level") // 0-100%
  damageDescription String? @map("damage_description")
  storageLocation String?   @map("storage_location") // склад + ячейка
  
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  // Relations
  client        User        @relation("ClientTires", fields: [clientId], references: [id], onDelete: Cascade)
  dotCodes      TireDotCode[]
  photos        TirePhoto[]
  orderTires    OrderTire[]
  
  @@index([clientId, status])
  @@index([status])
  @@map("tires")
}

model TireDotCode {
  id            String   @id @default(uuid())
  tireId        String   @map("tire_id")
  dotCode       String   @map("dot_code")
  position      String?  // FL, FR, RL, RR
  
  tire          Tire     @relation(fields: [tireId], references: [id], onDelete: Cascade)
  
  @@unique([tireId, dotCode])
  @@index([dotCode])
  @@map("tire_dot_codes")
}

model TirePhoto {
  id            String   @id @default(uuid())
  tireId        String   @map("tire_id")
  url           String
  storageType   String   @default("google-drive") @map("storage_type") // "google-drive" or "vercel-blob"
  thumbnailUrl  String?  @map("thumbnail_url")
  aiAnalysis    Json?    @map("ai_analysis") // Результат анализа Gemini
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  tire          Tire     @relation(fields: [tireId], references: [id], onDelete: Cascade)
  
  @@index([tireId])
  @@map("tire_photos")
}

model Order {
  id            String        @id @default(uuid())
  orderNumber   String        @unique @map("order_number")
  clientId      String        @map("client_id")
  managerId     String?       @map("manager_id")
  
  storagePeriod Int           @map("storage_period") // months
  startDate     DateTime      @map("start_date")
  endDate       DateTime      @map("end_date")
  reminderDate  DateTime      @map("reminder_date")
  
  warehouse     String
  cell          String
  
  totalCost     Decimal       @map("total_cost") @db.Decimal(10, 2)
  debt          Decimal       @default(0) @db.Decimal(10, 2)
  discountPercent Decimal     @default(0) @map("discount_percent") @db.Decimal(5, 2)
  
  status        OrderStatus   @default(active)
  paymentStatus PaymentStatus @default(unpaid) @map("payment_status")
  paymentMethod String?       @map("payment_method")
  
  notes         String?
  
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // Relations
  client        User          @relation("ClientOrders", fields: [clientId], references: [id], onDelete: Cascade)
  manager       User?         @relation("ManagerOrders", fields: [managerId], references: [id], onDelete: SetNull)
  orderTires    OrderTire[]
  services      OrderService[]
  
  @@index([clientId, status])
  @@index([status])
  @@index([reminderDate])
  @@index([orderNumber])
  @@map("orders")
}

model OrderTire {
  id            String   @id @default(uuid())
  orderId       String   @map("order_id")
  tireId        String   @map("tire_id")
  quantity      Int      @default(1)
  pricePerUnit  Decimal  @map("price_per_unit") @db.Decimal(10, 2)
  notes         String?
  
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  tire          Tire     @relation(fields: [tireId], references: [id], onDelete: Restrict)
  
  @@index([orderId])
  @@index([tireId])
  @@map("order_tires")
}

model OrderService {
  id            String      @id @default(uuid())
  orderId       String      @map("order_id")
  serviceType   ServiceType @map("service_type")
  description   String
  price         Decimal     @db.Decimal(10, 2)
  
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
  @@map("order_services")
}

model Appointment {
  id              String            @id @default(uuid())
  clientId        String            @map("client_id")
  partnerId       String            @map("partner_id")
  serviceType     ServiceType       @map("service_type")
  appointmentDate DateTime          @map("appointment_date")
  status          AppointmentStatus @default(pending)
  notes           String?
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  // Relations
  client          User              @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)
  partner         User              @relation("PartnerAppointments", fields: [partnerId], references: [id], onDelete: Cascade)
  
  @@index([partnerId, appointmentDate])
  @@index([clientId])
  @@index([status])
  @@map("appointments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  message   String
  data      Json?
  isSent    Boolean  @default(false) @map("is_sent")
  sentAt    DateTime? @map("sent_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isSent])
  @@map("notifications")
}

model Settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("settings")
}
